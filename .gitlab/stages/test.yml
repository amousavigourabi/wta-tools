variables:
  PITEST_OPTS: "-DwithHistory"

unit-tests-core:
  stage: test

  needs: [build-core]

  dependencies:
    - build-core

  script:
    - echo "Core unit tests started"
    - "mvn -pl core jacoco:prepare-agent surefire:test jacoco:report"
    - "mv -f core/target/jacoco.exec core/target/jacoco-unit-tests.exec"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: unit-tests-core
    expire_in: 3 days
    when: always
    paths:
      - core/reports/jacoco/
      - core/target/jacoco-unit-tests.exec

unit-tests-spark-adapter:
  stage: test

  needs: [build-spark-adapter]

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter unit tests started"
    - "mvn -pl adapter/spark jacoco:prepare-agent surefire:test jacoco:report"
    - "mv -f adapter/spark/target/jacoco.exec adapter/spark/target/jacoco-unit-tests.exec"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: unit-tests-spark-adapter
    expire_in: 3 days
    when: always
    paths:
      - adapter/spark/reports/jacoco/
      - adapter/spark/target/jacoco-unit-tests.exec


integration-tests-core:
  stage: test

  needs: [build-core]

  dependencies:
    - build-core

  script:
    - echo "Core integration tests started"
    - "mvn -pl core jacoco:prepare-agent-integration failsafe:integration-test@all-tests failsafe:verify jacoco:report-integration"
    - "mv -f core/target/jacoco.exec core/target/jacoco-integration-tests.exec"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: integration-tests-core
    expire_in: 3 days
    when: always
    paths:
      - core/reports/jacoco/
      - core/target/jacoco-integration-tests.exec

integration-tests-spark-adapter:
  stage: test

  needs: [build-spark-adapter]

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter integration tests started"
    - "mvn -pl adapter/spark jacoco:prepare-agent-integration failsafe:integration-test@all-tests failsafe:verify jacoco:report-integration"
    - "mv -f adapter/spark/target/jacoco.exec adapter/spark/target/jacoco-integration-tests.exec"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: integration-tests-spark-adapter
    expire_in: 3 days
    when: always
    paths:
      - adapter/spark/reports/jacoco/
      - adapter/spark/target/jacoco-integration-tests.exec


environment-integration-tests-core:
  stage: test

  needs: [build-linux-tooling-image, build-core]

  dependencies:
    - build-core

  script:
    - echo "Core environment integration tests started"
    - "mvn -pl core jacoco:prepare-agent-integration failsafe:integration-test@env-tests failsafe:verify jacoco:report-integration"
    - "mv -f core/target/jacoco.exec core/target/jacoco-environment-integration-tests.exec"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: environment-integration-tests-core
    expire_in: 3 days
    when: always
    paths:
      - core/reports/jacoco/
      - core/target/jacoco-environment-integration-tests.exec

environment-integration-tests-spark-adapter:
  stage: test

  needs: [build-linux-tooling-image, build-spark-adapter]

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter environment integration tests started"
    - "mvn -pl adapter/spark jacoco:prepare-agent-integration failsafe:integration-test@env-tests failsafe:verify jacoco:report-integration"
    - "mv -f adapter/spark/target/jacoco.exec adapter/spark/target/jacoco-environment-integration-tests.exec"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: environment-integration-tests-spark-adapter
    expire_in: 3 days
    when: always
    paths:
      - adapter/spark/reports/jacoco/
      - adapter/spark/target/jacoco-environment-integration-tests.exec


mutation-tests-core:
  stage: test

  needs: [build-core]

  dependencies:
    - build-core

  script:
    - echo "Core mutation tests core started"
    - "mvn -pl core $PITEST_OPTS pitest:mutationCoverage"
    - "cat core/reports/pitest/index.html | awk -F '</?td>' 'FNR == 25 { print $2 }' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: mutation-tests-core
    expire_in: 3 days
    when: always
    paths:
      - core/reports/pitest/

mutation-tests-spark-adapter:
  stage: test

  needs: [build-spark-adapter]

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter mutation tests started"
    - "mvn -pl adapter/spark $PITEST_OPTS pitest:mutationCoverage"
    - "cat adapter/spark/reports/pitest/index.html | awk -F '</?td>' 'FNR == 25 { print $2 }' || echo '0%'"

  coverage: /([0-9]{1,3})%/

  artifacts:
    name: mutation-tests-spark-adapter
    expire_in: 3 days
    when: always
    paths:
      - adapter/spark/reports/pitest/


line-coverage-core:
  stage: coverage
  needs: [environment-integration-tests-core, integration-tests-core, unit-tests-core]
  dependencies:
    - environment-integration-tests-core
    - integration-tests-core
    - unit-tests-core
  script:
    - echo "Started creating core line coverage report"
    - "mvn jacoco:merge jacoco:report"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"
  coverage: /([0-9]{1,3})%/
  artifacts:
    name: line-coverage-core
    expire_in: 3 days
    when: always
    paths:
      - core/reports/jacoco/
      - core/target/jacoco.exec

line-coverage-spark-adapter:
  stage: coverage
  needs: [environment-integration-tests-spark-adapter, integration-tests-spark-adapter, unit-tests-spark-adapter]
  dependencies:
    - environment-integration-tests-spark-adapter
    - integration-tests-spark-adapter
    - unit-tests-spark-adapter
  script:
    - echo "Started creating Spark adapter line coverage report"
    - "mvn jacoco:merge jacoco:report"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"
  coverage: /([0-9]{1,3})%/
  artifacts:
    name: line-coverage-spark-adapter
    expire_in: 3 days
    when: always
    paths:
      - adapter/spark/reports/jacoco/
      - adapter/spark/target/jacoco.exec


branch-coverage-core:
  stage: coverage
  needs: [line-coverage-core]
  dependencies:
    - line-coverage-core
  script:
    - echo "Started creating core branch coverage report"

branch-coverage-spark-adapter:
  stage: coverage
  needs: [line-coverage-spark-adapter]
  dependencies:
    - line-coverage-spark-adapter
  script:
    - echo "Started creating Spark adapter branch coverage report"


end-to-end-run-spark-adapter:
  stage: test

  needs: [package-spark-adapter, build-spark-adapter-image]

  dependencies:
    - package-spark-adapter
    - build-spark-adapter-image

  script:
    - echo "Spark adapter end-to-end run started"
    - echo "This job does not provide coverage metrics, it just verifies the system as a whole functions to some degree"
    - echo "This job is empty now, but will be used to spot some pressing issues with the application"
