line-coverage-core:
  stage: coverage
  needs: [environment-integration-tests-core, integration-tests-core, unit-tests-core, build-core]
  dependencies:
    - environment-integration-tests-core
    - integration-tests-core
    - unit-tests-core
    - build-core
  script:
    - echo "Started creating core line coverage"
    - "rm -rf core/reports/jacoco"
    - "mvn -pl core jacoco:merge jacoco:report"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"
  coverage: /([0-9]{1,3})%/
  artifacts:
    name: line-coverage-core
    expire_in: 3 days
    when: always
    paths:
      - core/reports/jacoco/
      - core/target/jacoco.exec

line-coverage-spark-adapter:
  stage: coverage
  needs: [environment-integration-tests-spark-adapter, integration-tests-spark-adapter, unit-tests-spark-adapter, build-spark-adapter]
  dependencies:
    - environment-integration-tests-spark-adapter
    - integration-tests-spark-adapter
    - unit-tests-spark-adapter
    - build-spark-adapter
  script:
    - echo "Started creating Spark adapter line coverage"
    - "rm -rf adapter/spark/reports/jacoco"
    - "mvn -pl adapter/spark jacoco:merge jacoco:report"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"
  coverage: /([0-9]{1,3})%/
  artifacts:
    name: line-coverage-spark-adapter
    expire_in: 3 days
    when: always
    paths:
      - adapter/spark/reports/jacoco/
      - adapter/spark/target/jacoco.exec


branch-coverage-core:
  stage: coverage
  needs: [line-coverage-core]
  dependencies:
    - line-coverage-core
  script:
    - echo "Started generating core branch coverage"

branch-coverage-spark-adapter:
  stage: coverage
  needs: [line-coverage-spark-adapter]
  dependencies:
    - line-coverage-spark-adapter
  script:
    - echo "Started generating Spark adapter branch coverage"
