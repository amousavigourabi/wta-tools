unit-tests-core:
  stage: tests

  dependencies:
    - build-core

  script:
    - echo "Core unit tests started"
    - "mvn -pl core jacoco:prepare-agent surefire:test jacoco:report"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

unit-tests-spark-adapter:
  stage: tests

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter unit tests started"
    - "mvn -pl adapter/spark jacoco:prepare-agent surefire:test jacoco:report"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/


integration-tests-core:
  stage: tests

  dependencies:
    - build-core

  script:
    - echo "Core integration tests started"
    - "mvn -pl core jacoco:prepare-agent-integration failsafe:integration-test jacoco:report-integration"
    - "cat core/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/

integration-tests-spark-adapter:
  stage: tests

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter integration tests started"
    - "mvn -pl adapter/spark jacoco:prepare-agent-integration failsafe:integration-test jacoco:report-integration"
    - "cat adapter/spark/reports/jacoco/index.html | grep -Po 'Total.*?([0-9]{1,3})%' || echo '0%'"

  coverage: /([0-9]{1,3})%/


mutation-tests-core:
  stage: tests
  allow_failure: true

  dependencies:
    - build-core

  script:
    - echo "Core mutation tests core started"
    - "mvn -pl core pitest:mutationCoverage"
    - "cat core/reports/pitest/index.html | grep -Po '<tbody><tr><td>.*?<td>.*?<td>.*?([0-9]{1,3})%'"

  coverage: /([0-9]{1,3})%/

mutation-tests-spark-adapter:
  stage: tests
  allow_failure: true

  dependencies:
    - build-spark-adapter

  script:
    - echo "Spark adapter mutation tests adapter/spark started"
    - "mvn -pl adapter/spark pitest:mutationCoverage"
    - "cat adapter/spark/reports/pitest/index.html | grep -Po '<tbody><tr><td>.*?<td>.*?<td>.*?([0-9]{1,3})%'"

  coverage: /([0-9]{1,3})%/
