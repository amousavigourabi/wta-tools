variables:
  IMAGE_RELEASE_TAG: 1.0.3
  BASE_IMAGE: $CI_REGISTRY_IMAGE/base-image:$IMAGE_RELEASE_TAG
  LINUX_TOOLING_IMAGE: $CI_REGISTRY_IMAGE/linux-tooling-image:$IMAGE_RELEASE_TAG
  SPARK_IMAGE_2_12: $CI_REGISTRY_IMAGE/spark-image_2_12:$IMAGE_RELEASE_TAG
  SPARK_BAREBONES_IMAGE_2_12: $CI_REGISTRY_IMAGE/barebones-spark-image_2_12:$IMAGE_RELEASE_TAG
  SPARK_IMAGE_2_13: $CI_REGISTRY_IMAGE/spark-image_2_13:$IMAGE_RELEASE_TAG
  SPARK_BAREBONES_IMAGE_2_13: $CI_REGISTRY_IMAGE/barebones-spark-image_2_13:$IMAGE_RELEASE_TAG

build-base-image:
  stage: images
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $BASE_IMAGE >/dev/null ; then exit 0 ; fi
    - docker build -t $BASE_IMAGE .gitlab/dockerfiles/base
    - docker push $BASE_IMAGE


build-linux-tooling-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $LINUX_TOOLING_IMAGE >/dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$BASE_IMAGE -t $LINUX_TOOLING_IMAGE .gitlab/dockerfiles/linux-tooling
    - docker push $LINUX_TOOLING_IMAGE


build-barebones-spark-adapter-image_2_12:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $SPARK_BAREBONES_IMAGE_2_12 > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$BASE_IMAGE -t $SPARK_BAREBONES_IMAGE_2_12 .gitlab/dockerfiles/spark-adapter_2_12
    - docker push $SPARK_BAREBONES_IMAGE_2_12

build-spark-adapter-image_2_12:
  stage: images
  image: docker:20.10.16
  needs: [build-barebones-spark-adapter-image_2_12]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $SPARK_IMAGE_2_12 > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$SPARK_BAREBONES_IMAGE_2_12 -t $SPARK_IMAGE_2_12 .gitlab/dockerfiles/linux-tooling
    - docker push $SPARK_IMAGE_2_12


build-barebones-spark-adapter-image_2_13:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $SPARK_BAREBONES_IMAGE_2_13 > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$BASE_IMAGE -t $SPARK_BAREBONES_IMAGE_2_13 .gitlab/dockerfiles/spark-adapter_2_13
    - docker push $SPARK_BAREBONES_IMAGE_2_13

build-spark-adapter-image_2_13:
  stage: images
  image: docker:20.10.16
  needs: [build-barebones-spark-adapter-image_2_13]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $SPARK_IMAGE_2_13 > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$SPARK_BAREBONES_IMAGE_2_13 -t $SPARK_IMAGE_2_13 .gitlab/dockerfiles/linux-tooling
    - docker push $SPARK_IMAGE_2_13
