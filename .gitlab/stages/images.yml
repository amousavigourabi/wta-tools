variables:
  IMAGE_RELEASE_TAG: 1.0.1-SNAPSHOT-1-ubuntu-2
  BASE_IMAGE: $CI_REGISTRY_IMAGE/base-image:$IMAGE_RELEASE_TAG
  LINUX_TOOLING_IMAGE: $CI_REGISTRY_IMAGE/linux-tooling-image:$IMAGE_RELEASE_TAG
  SPARK_IMAGE: $CI_REGISTRY_IMAGE/spark-image:$IMAGE_RELEASE_TAG
  SPARK_BAREBONES_IMAGE: $CI_REGISTRY_IMAGE/barebones-spark-image:$IMAGE_RELEASE_TAG

build-base-image:
  stage: images
  image: docker:20.10.16
  needs: []
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $BASE_IMAGE > /dev/null ; then exit 0 ; fi
    - docker build -t $BASE_IMAGE .gitlab/dockerfiles/base
    - docker push $BASE_IMAGE

build-linux-tooling-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $LINUX_TOOLING_IMAGE > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$BASE_IMAGE -t $LINUX_TOOLING_IMAGE .gitlab/dockerfiles/linux-tooling
    - docker push $LINUX_TOOLING_IMAGE

build-spark-adapter-image:
  stage: images
  image: docker:20.10.16
  needs: [build-barebones-spark-adapter-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $SPARK_IMAGE > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$SPARK_BAREBONES_IMAGE -t $SPARK_IMAGE .gitlab/dockerfiles/linux-tooling
    - docker push $SPARK_IMAGE

build-barebones-spark-adapter-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if docker manifest inspect $SPARK_BAREBONES_IMAGE > /dev/null ; then exit 0 ; fi
    - docker build --build-arg base_image=$BASE_IMAGE -t $SPARK_BAREBONES_IMAGE .gitlab/dockerfiles/spark-adapter
    - docker push $SPARK_BAREBONES_IMAGE
