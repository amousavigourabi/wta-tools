build-base-image:
  stage: images
  image: docker:20.10.16
  needs: []
  services:
    - docker:20.10.16-dind
  script:
    - docker build -t base-image docker/base
    - docker save base-image > base-image.tar
  artifacts:
    name: base-image
    expire_in: 3 days
    when: always
    paths:
      - base-image.tar

build-linux-tooling-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  dependencies:
    - build-base-image
  services:
    - docker:20.10.16-dind
  script:
    - docker load < base-image.tar
    - docker build -t linux-tooling-setup-image docker/linux-tooling
    - docker save linux-tooling-setup-image > linux-tooling-setup-image.tar
  artifacts:
    name: linux-tooling-image
    expire_in: 3 days
    when: always
    paths:
      - linux-tooling-setup-image.tar

build-spark-adapter-image:
  stage: images
  image: docker:20.10.16
  needs: [build-barebones-spark-adapter-image]
  dependencies:
    - build-barebones-spark-adapter-image
  services:
    - docker:20.10.16-dind
  script:
    - docker load < barebones-spark-setup-image.tar
    - docker build --build-arg base_image=barebones-spark-setup-image -t spark-setup-image docker/linux-tooling
    - docker save spark-setup-image > spark-setup-image.tar
  artifacts:
    name: spark-image
    expire_in: 3 days
    when: always
    paths:
      - spark-setup-image.tar

build-barebones-spark-adapter-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  dependencies:
    - build-base-image
  services:
    - docker:20.10.16-dind
  script:
    - docker load < base-image.tar
    - docker build -t barebones-spark-setup-image docker/spark-adapter
    - docker save barebones-spark-setup-image > barebones-spark-setup-image.tar
  artifacts:
    name: barebones-spark-image
    expire_in: 3 days
    when: always
    paths:
      - barebones-spark-setup-image.tar
