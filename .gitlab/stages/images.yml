variables:
  IMAGE_RELEASE: 0.0.0
  BASE_IMAGE_TAG: $CI_REGISTRY_IMAGE/base-image:$IMAGE_RELEASE
  LINUX_TOOLING_IMAGE_TAG: $CI_REGISTRY_IMAGE/linux-tooling-image:$IMAGE_RELEASE
  SPARK_IMAGE_TAG: $CI_REGISTRY_IMAGE/spark-image:$IMAGE_RELEASE
  SPARK_BAREBONES_IMAGE_TAG: $CI_REGISTRY_IMAGE/barebones-spark-image:$IMAGE_RELEASE

build-base-image:
  stage: images
  image: docker:20.10.16
  needs: []
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $BASE_IMAGE_TAG docker/base
    - docker push $BASE_IMAGE_TAG

build-linux-tooling-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --build-arg base_image=$BASE_IMAGE_TAG -t $LINUX_TOOLING_IMAGE_TAG docker/linux-tooling
    - docker push $LINUX_TOOLING_IMAGE_TAG

build-spark-adapter-image:
  stage: images
  image: docker:20.10.16
  needs: [build-barebones-spark-adapter-image]
  dependencies:
    - build-barebones-spark-adapter-image
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --build-arg base_image=$SPARK_BAREBONES_IMAGE_TAG -t $SPARK_IMAGE_TAG docker/linux-tooling
    - docker push $SPARK_IMAGE_TAG

build-barebones-spark-adapter-image:
  stage: images
  image: docker:20.10.16
  needs: [build-base-image]
  services:
    - docker:20.10.16-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --build-arg base_image=$BASE_IMAGE_TAG -t $SPARK_BAREBONES_IMAGE_TAG docker/spark-adapter
    - docker push $SPARK_BAREBONES_IMAGE_TAG
